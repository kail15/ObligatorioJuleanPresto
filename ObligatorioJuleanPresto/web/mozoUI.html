<!DOCTYPE html>

<html>
    <head>
        <title>Mozos</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            .squareRed {
                margin-left: 30px;
                margin-bottom: 10px;
                padding: 8px;
                height: 50px;
                width: 50px;
                background-color: red;
            }

            .squareGreen {
                border-width:1px;
                margin-left: 30px;
                margin-bottom: 10px;
                padding: 8px;
                height: 50px;
                width: 50px;
                background-color: greenyellow;
            }

            .marginForm{
                margin-left: 30px;
            }

            #divServicios{
                border-width:1px;
                margin: 0 auto;               
                height: 100px;
                width: 300px;
            }

        </style>
    </head>
    <body> 
        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script>
            var userId = sessionStorage.getItem("userId");
            var webSocket = new WebSocket("ws://localhost:8080/ObligatorioJuleanPresto/wsMozo/" + userId);
            var selectProductos = [];

            var currentMesa = {
                "numero": 0,
                "estadoMesa": false,
            };

            var mesas = [];

            var nombreMozo;
            //Capturo Evento onBeforeUnload
            window.onbeforeunload = function () {
                //Cierro la conexion manualmente 
                webSocket.close();
            };
            webSocket.onopen = function (message) {

            };

            webSocket.onmessage = function (message) {
                var jsonObject = JSON.parse(message.data);
                var tipo = jsonObject.tipo;
                var valor = jsonObject.valor;
                switch (tipo) {
                    case "TIPO_MOSTRAR_MOZO":
                        mostrarMozo(valor);
                        break;
                    case "TIPO_CAMBIAR_ESTADO_MESA":
                        $('#mesasMozo').empty();
                        mostrarMozo(valor);
                        break;
                    case "TIPO_OBTENER_PRODUCTOS":
                        cargarProductos(valor);
                        break;
                    case "TIPO_MOZOS_LOGUEADOS":
                        cargarMozosLogueados(valor);
                        break;
                    case "TIPO_TRANSFERIR_MESA_ENVIAR":
                        if (valor.mozoDestino === userId) {
                            solicitudMesa(valor);
                        }
                        break;
                    case "TIPO_ACEPTAR_MESA":
                        if (valor.mozoOrigen === userId) {
                            var acepta = " a aceptado la mesa.";
                            if (!valor.aceptaMesa) {
                                acepta = " no a acepatado la mesa.";
                            }
                            var mensajeMesa = valor.mozoDestinoNombre + acepta;
                            alert(mensajeMesa);
                        }
                        break;
                    case "ERROR_LOGOUT":
                        alert(valor);
                        break;
                    case "TIPO_LOGOUT":
                        if (valor.userId === userId) {
                            window.location.href = "login.html";
                        }
                        break;
                    case "TIPO_DEVOLVER_SERVICIO":
                        pedidoTerminado(valor);
                        break;
                    case "TIPO_AVISAR_PEDIDO":
                        avisarPedido(valor);
                    default:
                        break;
                }
            };


            function avisarPedido(pedido) {

                var estadoPed = "";
                if (pedido.estado === "EN_ESPERA") {
                    estadoPed = "En espera";
                } else if (pedido.estado === "PROCESADO") {
                    estadoPed = "Procesando";
                } else if (pedido.estado === "FINALIZADO") {
                    estadoPed = "Finalizado";
                }

                var mensjePedido = "Producto: " + pedido.nombreProducto + '\n' + "Gestor: " + pedido.mozoNombre + '\n' + "Estado: " + estadoPed;

                alert(mensjePedido);

            }

            function pedidoTerminado(servicio) {
                console.log(servicio);
                if (servicio.mozoId === userId) {
                    var mensajeServicio = "Cliente: " + servicio.nombreCliente + '\n' + "Monto original: $" + servicio.totalApagar
                            + '\n' + "Descuento : $" + servicio.descuentoServicio + '\n' + "TotalApagar a pagar: $" + servicio.costoServicio;
                    alert(mensajeServicio);
                }

            }

            function solicitudMesa(valor) {
                setTimeout(function () {
                    var estado = "cerrada";
                    if (valor.estadoMesa) {
                        estado = "abierta";
                    }
                    var acepta = window.confirm(valor.mozoOrigenNombre + ' Desea transferir la mesa: ' + valor.numero + ' ' + estado + '.');
                    var jsonObjectMesaTransf = {
                        "numero": valor.numero,
                        "mozoOrigen": valor.mozoOrigen,
                        "mozoDestino": valor.mozoDestino,
                        "mozoOrigenNombre": valor.mozoOrigenNombre,
                        "mozoDestinoNombre": valor.mozoDestinoNombre,
                        "aceptaMesa": false,
                        "estadoMesa": valor.estadoMesa,
                        "tipo": "TIPO_ACEPTAR_MESA"
                    };
                    if (acepta) {
                        jsonObjectMesaTransf.aceptaMesa = true;
                    }
                    var agregarJson = JSON.stringify(jsonObjectMesaTransf);
                    webSocket.send(agregarJson);
                }, 2000);
            }

            function mostrarMozo(valor) {
                $("#divServicios").hide();
                mesas = [];
                nombreMozo = valor.nombreCompleto;
                $('#mesasMozo').text("");
                $.each(valor.mesas, function (key, value) {

                    var servicioObj = {
                        "costoServicio": value.servicio.costoServicio,
                        "items": []
                    };
                    var mesaObj = {
                        "numero": value.numero,
                        "estado": value.estado,
                        "servicio": servicioObj
                    };
                    if (value.servicio.pedidos.length > 0) {
                        $.each(value.servicio.pedidos, function (key, ped) {

                            var estadoPed = "";
                            if (ped.estado === "EN_ESPERA") {
                                estadoPed = "En espera";
                            } else if (ped.estado === "PROCESADO") {
                                estadoPed = "Procesando";
                            } else if (ped.estado === "FINALIZADO") {
                                estadoPed = "Finalizado";
                            }
                            var itemObj = {
                                "nombreProducto": ped.nombreProducto,
                                "cantidad": ped.cantidad,
                                "precioProducto": ped.precioProducto,
                                "total": ped.cantidad * ped.precioProducto,
                                "estado": estadoPed,
                                "gestorNombre": ped.gestorNombre
                            };
                            servicioObj.items.push(itemObj);
                        });
                    }

                    mesas.push(mesaObj);
                    if (value.estado) {
                        $('#mesasMozo').append('<div class="squareGreen" id=' + value.numero + '> Mesa: ' + value.numero + '</div>');
                    } else {
                        $('#mesasMozo').append('<div class="squareRed"  id=' + value.numero + ' > Mesa: ' + value.numero + '</div>');
                    }

                    $('#mesasMozo').append('<form id=' + "form" + value.numero + ' class="marginForm" ></form>');
                    $('#' + "form" + value.numero).append('<input type="button" id=' + "btnAbrir" + value.numero + ' value="abrir" >');
                    $('#' + "form" + value.numero).append('<input type="button" id=' + "btnCerrar" + value.numero + ' value="cerrar" >');
                    $('#' + "form" + value.numero).append('<input type="button" id=' + "btnPedido" + value.numero + ' value="pedido" >');
                    $('#' + "form" + value.numero).append('<input type="button" id=' + "btnTransfer" + value.numero + ' value="transferir" >');
                    if (value.estado) {
                        $('#' + "btnAbrir" + value.numero).attr('disabled', 'disabled');
                    } else {
                        $('#' + "btnCerrar" + value.numero).attr('disabled', 'disabled');
                        $('#' + "btnPedido" + value.numero).attr('disabled', 'disabled');
                    }

                    $('#' + "form" + value.numero).attr("style", "display:none");
                    $('#mesasMozo').append('<br/>');
                    //click de la mesa
                    var idMesa = value.numero.toString();
                    $("#" + idMesa).click(function () {
                        abrirCuadro("form" + value.numero, value);
                    });
                    //click abrir
                    var idAbrir = "btnAbrir" + value.numero.toString();
                    $("#" + idAbrir).click(function () {
                        abrirMesa(idMesa, value);
                    });
                    //click cerrar
                    var idCerrar = "btnCerrar" + value.numero.toString();
                    $("#" + idCerrar).click(function () {
                        abrirMesa(idMesa, value);
                    });
                    //click agregar producto
                    var idAgregar = "btnPedido" + value.numero;
                    $("#" + idAgregar).click(function () {
                        abrirCuadroProd(idAgregar);
                    });
                    //click transferir mesa
                    var idTransf = "btnTransfer" + value.numero;
                    $("#" + idTransf).click(function () {
                        abrirCuadroMozosLog(value.numero, value.estado);
                    });
                });
                $("#titleName").text('Mozo: ' + valor.nombreCompleto);
            }

            function abrirCuadroMozosLog(numero, estado) {
                currentMesa.numero = numero;
                currentMesa.estadoMesa = estado;
                $("#formProductos").css("display", "none");
                var esVisible = $("#formMozosLog").is(":visible");
                if (esVisible) {
                    $("#formMozosLog").css("display", "none");
                } else {
                    $("#formMozosLog").css("display", "block");
                }
            }

            function cargarMozosLogueados(valor) {
                $("#selectMozosLog").empty();
                if (valor.length > 1) {
                    $.each(valor, function (key, value) {
                        if (value.userId !== userId) {
                            $("#selectMozosLog").append('<option value=' + value.userId + '>' + value.nombreCompleto + '</option>');
                        }
                    });
                } else {
                    $("#selectMozosLog").append('<option value="null">No se encuentran otros mozos logueados</option>');
                }
            }

            function cargarProductos(valor) {
                $("#infoProd").empty();
                $("#selectProductos").empty();
                $("#selectProductos").append('<option value=' + null + '> Seleccione un producto </option>');
                $.each(valor, function (key, value) {
                    $("#selectProductos").append('<option value=' + value.codigo + '>' + value.nombre + '</option>');
                    var prod = {
                        codigo: value.codigo,
                        nombre: value.nombre,
                        precio: value.precioUnitario,
                        stock: value.stockDisponible,
                        unidadId: value.unidadProcesadora.id,
                        unidadNombre: value.unidadProcesadora.nombre
                    };
                    selectProductos.push(prod);
                });
            }

            function cargarInfoProd() {
                var infoProd = obtenerInfoProd($("#selectProductos").val());
                var idSelect = $("#selectProductos").val();
                $("#infoProd").empty();
                if (idSelect !== 'null') {
                    $("#infoProd").append("<li>" + '<b>Producto:</b> ' + infoProd.nombre + "</li>");
                    $("#infoProd").append("<li>" + '<b>Precio:</b> ' + "$ " + infoProd.precio + "</li>");
                    $("#infoProd").append("<li>" + '<b>Stock:</b> ' + infoProd.stock + "</li>");
                    $("#infoProd").append("<li>" + '<b>Unidad:</b> ' + infoProd.unidadNombre + "</li>");
                }
            }

            function obtenerInfoProd(valor) {
                var prod;
                $.each(selectProductos, function (key, value) {
                    if (parseInt(valor) === value.codigo) {
                        prod = {
                            codigo: value.codigo,
                            nombre: value.nombre,
                            precio: value.precio,
                            stock: value.stock,
                            unidadId: value.unidadId,
                            unidadNombre: value.unidadNombre
                        };
                    }
                });
                return prod;
            }

            function abrirCuadro(idForm, value) {

                $("#formProductos").hide();
                $("#formMozosLog").hide();
                currentMesa.numero = value.numero;
                currentMesa.estadoMesa = value.estado;
                if (currentMesa.estadoMesa) {
                    var esVisible = $("#divServicios").is(":visible");
                    if (esVisible) {
                        $("#divServicios").hide();
                    } else {
                        $("#divServicios").show();
                        mostrarServicio(currentMesa.numero);
                    }
                }

                $('.marginForm').each(function (i, obj) {
                    if (idForm !== obj.id) {
                        $("#" + obj.id).css("display", "none");
                    }
                });
                var esVisible = $("#" + idForm).is(":visible");
                if (esVisible) {
                    $("#" + idForm).css("display", "none");
                } else {
                    $("#" + idForm).css("display", "block");
                }
            }

            //Abre cuadro de servicios
            function mostrarServicio(idMesa) {
                $("#divServicios").text("");
                $("#divServicios").append('<h3>Datos del servicio de la mesa: ' + idMesa + '</h3>');
                var mesaPedido;
                $.each(mesas, function (key, m) {
                    if (m.numero === idMesa) {
                        mesaPedido = m;
                    }
                });
                var items = mesaPedido.servicio.items;
                if (items.length > 0) {
                    $("#divServicios").append('<b>Productos</b>');
                    var totalServicio = mesaPedido.servicio.costoServicio;
                    $.each(items, function (key, item) {
                        var gestor = "Aún no fué tomado.";
                        if (item.gestorNombre !== "") {
                            gestor = item.gestorNombre;
                        }
                        var ulServicio = '<ul>';
                        var liProd = '<li>' + '<b>Producto:</b> ' + item.nombreProducto + '</li>';
                        var liCant = '<li>' + '<b>Cantidad:</b> ' + item.cantidad + '</li>';
                        var liPrec = '<li>' + '<b>Precio:</b> ' + '$' + item.precioProducto + '</li>';
                        var liTot = '<li>' + '<b>Total:</b> ' + '$' + item.total + '</li>';
                        var liEstado = '<li>' + '<b>Estado:</b> ' + item.estado + '</li>';
                        var liGestor = '<li>' + '<b>Gestor:</b> ' + gestor + '</li>';
                        ulServicio += liProd + liCant + liPrec + liTot + liEstado + liGestor + '</ul>';
                        $("#divServicios").append(ulServicio);
                        $("#divServicios").append('<hr>');
                    });
                    $("#divServicios").append('<div>' + 'Total: $' + totalServicio + '</div>');
                    $("#divServicios").append('<br/>');
                    $("#divServicios").append('<input type="button" value="confirmar" id="btnConfirmarPedido" onclick="confirmarPedido(' + idMesa + ')"/>');
                    $("#divServicios").append('<input type="number" id="txtIdCliente" placeholder="ingresar cliente"/>');
                } else {
                    $("#divServicios").append('<div> <b>Sin pedidos actualmente.</b> </div>');
                }
            }

            function confirmarPedido(idMesa) {
                var idCli = $("#txtIdCliente").val();
                if (idCli > 0) {
                    if (idCli === "") {
                        idCli = 0;
                    }
                    var mesaJson = {
                        "numero": idMesa,
                        "clienteId": idCli,
                        "tipo": "TIPO_CONFIRMAR_SERVICIO"
                    };
                    var agregarJson = JSON.stringify(mesaJson);
                    webSocket.send(agregarJson);
                } else {
                    alert("El numero de cliente debe ser vacio o mayor a 0");
                    $("#txtIdCliente").val("");
                }
            }

            function abrirCuadroProd(id) {
                var esVisible = $("#formProductos").is(":visible");
                $("#formMozosLog").css("display", "none");
                if (esVisible) {
                    $("#formProductos").css("display", "none");
                } else {
                    $("#formProductos").css("display", "block");
                }
            }

            function abrirMesa(id, value) {
                var estadoMesa = false;
                if (value.estado) {
                    $("#" + id).removeClass('squareGreen');
                    $("#" + id).addClass('squareRed');
                    $("#formProductos").css("display", "none");
                } else {
                    $("#" + id).removeClass('squareRed');
                    $("#" + id).addClass('squareGreen');
                    estadoMesa = true;
                }

                $("#" + id).removeClass('squareGreen');
                $("#" + id).addClass('squareRed');
                var jsonObject = {
                    "numero": value.numero,
                    "estado": estadoMesa,
                    "tipo": "TIPO_CAMBIAR_ESTADO_MESA"
                };
                var agregarJson = JSON.stringify(jsonObject);
                webSocket.send(agregarJson);
            }

            function agregarPedido() {
                var idProd = $("#selectProductos").val();
                if (idProd !== 'null') {
                    var cantidad = parseInt($("#cantidadProd").val());
                    var descripcion = $("#descProd").val();
                    var mesa = parseInt(currentMesa.numero);
                    var jsonObject = {
                        "producto": idProd,
                        "cantidad": cantidad,
                        "descripcion": descripcion,
                        "mesa": mesa,
                        "mozoId": userId,
                        "tipo": "TIPO_AGREGAR_PEDIDO"
                    };
                    var agregarJson = JSON.stringify(jsonObject);
                    webSocket.send(agregarJson);
                    $("#formProductos").hide();
                    $("#cantidadProd").val("");
                    $("#descProd").val("");
                    alert("El producto fue enviado");
                } else {
                    alert("Debes seleccionar un producto de la lista");
                }
            }

            function transferirMesa() {
                var mozoDestNom = $("#selectMozosLog").text();
                var mozoDestId = $("#selectMozosLog").val();
                if (mozoDestId === 'null') {
                    alert("No hay mozos logueados aún");
                } else {

                    $(".marginForm").css("display", "none");
                    var jsonObject = {
                        "numero": currentMesa.numero,
                        "mozoOrigen": userId,
                        "mozoDestino": mozoDestId,
                        "mozoOrigenNombre": nombreMozo,
                        "mozoDestinoNombre": mozoDestNom,
                        "estadoMesa": currentMesa.estadoMesa,
                        "tipo": "TIPO_TRANSFERIR_MESA"
                    };
                    $("#formMozosLog").css("display", "none");
                    var agregarJson = JSON.stringify(jsonObject);
                    webSocket.send(agregarJson);
                }
            }

            function logout() {

                var jsonObject = {
                    "userId": userId,
                    "tipo": "TIPO_LOGOUT"
                };
                var agregarJson = JSON.stringify(jsonObject);
                webSocket.send(agregarJson);
            }

        </script>

        <div id="divLogout">
            <input type="button" value="cerrar sesion" id="btnMozosLog" onclick="logout()"  />
            <h2 id="titleName"></h2>

        </div>
        <div id="divServicios" style="display:none">
            <h3>Datos del servicio</h3>

        </div>

        <br/>
        <div id="mesasMozo"></div>
        <form id="formMesa" ></form>
        <form id="formProductos" style="display:none">
            <select id="selectProductos" onchange="cargarInfoProd()"></select>
            <div id="divInfoProd" >              
                <section> 
                    <h3>Datos del producto</h3>
                    <ul id="infoProd" ></ul>
                    <div id="divCantProd" >
                        <label>Ingresar cantidad del producto</label><br/>
                        <input type="number" id="cantidadProd" placeholder="ingresar cantidad"/><br/>
                        <input type="text" id="descProd" placeholder="ingresar una descrición"/>

                    </div>
                </section>
                <input type="button" value="agregar" onclick="agregarPedido()">
            </div>
        </form>
        <form id="formMozosLog" style="display:none">
            <h3>Seleccionar mozo</h3><br/>
            <select id="selectMozosLog">
            </select><br/>
            <input type="button" value="confirmar" id="btnMozosLog" onclick="transferirMesa()"  />    
        </form>
    </body>
</html>
